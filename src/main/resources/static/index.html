<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Produkty – CRUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial, sans-serif; margin:20px; max-width:900px}
    h1{margin:0 0 10px}
    small{color:#555}
    form{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0 6px}
    label{font-size:12px; color:#444}
    input{width:100%; padding:8px; box-sizing:border-box}
    .row{grid-column:1 / -1; display:flex; gap:8px}
    button{padding:8px 12px; cursor:pointer}
    #msg{grid-column:1 / -1; color:#c00; min-height:1.2em}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border:1px solid #ddd; padding:8px; text-align:left}
    th{background:#f5f5f5}
    .actions{display:flex; gap:6px}
  </style>
</head>
<body>
<h1>Produkty – CRUD</h1>
<small>Prosty frontend: dodaj, edytuj, usuń, lista</small>

<form id="form">
  <input type="hidden" id="id">
  <div>
    <label>Nazwa</label>
    <input id="name" required>
  </div>
  <div>
    <label>Cena (PLN)</label>
    <input id="price" placeholder="np. 19,99" required>
  </div>
  <div>
    <label>Kategoria</label>
    <input id="category" required>
  </div>
  <div>
    <label>Data (YYYY-MM-DD)</label>
    <input id="createdAt" type="date" required>
  </div>
  <div class="row">
    <button type="submit">Zapisz</button>
    <button type="button" id="clear">Wyczyść</button>
  </div>
  <div id="msg"></div>
</form>

<table>
  <thead>
  <tr>
    <th>ID</th><th>Nazwa</th><th>Cena</th><th>Kategoria</th><th>Data</th><th>Akcje</th>
  </tr>
  </thead>
  <tbody id="tbody">
  <tr><td colspan="6" style="text-align:center;color:#777">Brak danych</td></tr>
  </tbody>
</table>

<script>
  const API = "/api/products";
  const $ = (id)=>document.getElementById(id);
  const tbody = $("tbody");

  function readForm(){
    return {
      name: $("name").value.trim(),
      // zamiana przecinka na kropkę, aby wysłać liczbę
      price: Number(String($("price").value).replace(",", ".")),
      category: $("category").value.trim(),
      createdAt: $("createdAt").value
    };
  }
  function fillForm(p={}){
    $("id").value = p.id || "";
    $("name").value = p.name || "";
    $("price").value = (p.price ?? "").toString();
    $("category").value = p.category || "";
    $("createdAt").value = p.createdAt || new Date().toISOString().slice(0,10);
  }
  function showMsg(t=""){ $("msg").textContent = t; }

  async function load(){
    const r = await fetch(API);
    if(!r.ok){ showMsg("Błąd połączenia z API"); return; }
    const data = await r.json();
    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#777">Brak danych</td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(p=>`
    <tr>
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${(Number(p.price)||0).toFixed(2)}</td>
      <td>${p.category}</td>
      <td>${p.createdAt}</td>
      <td class="actions">
        <button data-edit="${p.id}">Edytuj</button>
        <button data-del="${p.id}">Usuń</button>
      </td>
    </tr>
  `).join("");
  }

  $("form").onsubmit = async (e)=>{
    e.preventDefault(); showMsg("");
    const id = $("id").value;
    const payload = readForm();
    const r = await fetch(id ? `${API}/${id}` : API, {
      method: id ? "PUT" : "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!r.ok){ showMsg(await r.text() || "Błąd zapisu"); return; }
    fillForm(); // czyść form
    await load();
  };

  $("clear").onclick = ()=>{ fillForm(); showMsg(""); };

  tbody.addEventListener("click", async (e)=>{
    const idE = e.target.getAttribute("data-edit");
    const idD = e.target.getAttribute("data-del");
    if(idE){
      const r = await fetch(`${API}/${idE}`);
      if(r.ok) fillForm(await r.json());
    }
    if(idD){
      if(!confirm("Usunąć?")) return;
      const r = await fetch(`${API}/${idD}`, {method:"DELETE"});
      if(!r.ok){ showMsg("Nie udało się usunąć"); return; }
      await load();
    }
  });

  fillForm();
  load();
</script>
</body>
</html>
